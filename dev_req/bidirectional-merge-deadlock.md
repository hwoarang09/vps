## 맵 구조 정의 (Map Topology)
현재 맵은 두 개의 평행한 직선(Linear) 트랙과 이들을 연결하는 두 개의 U턴 곡선(Curve) 트랙으로 구성된 **순환형 구조(Circulation Loop)**입니다.

### 1. 노드 배치 (Node Layout)
* **상단 라인 (Top Line, West <-> East):** 좌측(N0346) --[E0397]-- 우측(N0345)
* **하단 라인 (Bottom Line, West <-> East):** 좌측(N0248) --[E0286]-- 우측(N0249)

### 2. 엣지 연결 및 방향성 (Edges & Connectivity)
모든 차량은 우측 통행(또는 지정된 방향)을 따르며, 흐름은 다음과 같습니다.

#### A. 하단 트랙 (Bottom Track) - 동쪽 방향(Eastbound)
* **Edge:** `E0286` (Type: Linear/Straight)
* **Flow:** `N0248` (Start) → `N0249` (End)
* **기능:** 하단 직진 주행

#### B. 상단 트랙 (Top Track) - 서쪽 방향(Westbound)
* **Edge:** `E0397` (Type: Linear/Straight)
* **Flow:** `N0345` (Start) → `N0346` (End)
* **기능:** 상단 직진 주행 (하단과 반대 방향 흐름)

#### C. 좌측 U턴 (Left U-Turn) - 분기 및 합류
* **Edge:** `E0549` (Type: Curve, 180deg)
* **Flow:** `N0248` (From) → `N0346` (To)
* **기능:** 하단 라인에서 상단 라인으로 U턴 합류

#### D. 우측 U턴 (Right U-Turn) - 분기 및 합류
* **Edge:** `E0722` (Type: Curve, 180deg)
* **Flow:** `N0345` (From) → `N0249` (To)
* **기능:** 상단 라인에서 하단 라인으로 U턴 합류

### 3. 분기 및 합류 지점 요약 (Merge/Branch Logic)
* **분기점 (Branch Nodes):**
    * `N0248`: 직진(`E0286`) 또는 U턴(`E0549`) 선택 가능
    * `N0345`: 직진(`E0397`) 또는 U턴(`E0722`) 선택 가능
* **합류점 (Merge Nodes):**
    * `N0249`: 하단 직진 차량(`E0286`)과 상단에서 내려온 U턴 차량(`E0722`)이 합류
    * `N0346`: 상단 직진 차량(`E0397`)과 하단에서 올라온 U턴 차량(`E0549`)이 합류

---

## 데드락 문제 (Deadlock Problem)

### 1. 데드락 발생 조건

```
            N0346 ←──── E0397 ←──── N0345
              ↑                        │
              │                        │
           E0549                    E0722
           (U턴)                    (U턴)
              │                        │
              │                        ↓
            N0248 ────→ E0286 ────→ N0249
```

**시나리오:**
1. 차량 A: E0549(U턴) → N0346 락 요청 (대기)
2. 차량 B: E0397(직진) → N0346 락 보유, N0249로 가야 함
3. 차량 C: E0722(U턴) → N0249 락 요청 (대기)
4. 차량 D: E0286(직진) → N0249 락 보유, N0346으로 가야 함

**결과:** 양쪽 합류점이 서로를 기다리며 순환 의존성 발생 → 데드락

### 2. 근본 원인
- 직선에서 멀리서 미리 락을 요청 (lockRequestDistanceFromMergingStr)
- 여러 차량이 동시에 서로 다른 합류점 락을 "미리" 보유
- 순환 구조에서 상호 대기 발생

---

## 정책 구조 (Policy Structure)

### 독립적인 두 가지 정책

```
┌─────────────────────────────────────────────────┐
│ 1. 일반 합류점 정책 (전역)                        │
│    lockGrantStrategy: FIFO | BATCH              │
│    → 평범한 합류점에 적용                         │
└─────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────┐
│ 2. 데드락 유발 존 정책 (별도)                     │
│    deadlockZoneStrategy: BRANCH_FIFO | ZONE_YIELD│
│    → 데드락 유발 존에만 적용                      │
│    → 일반 합류점 정책과 독립적                    │
└─────────────────────────────────────────────────┘
```

### Config 예시

```typescript
// simulationConfig.ts

// 일반 합류점 전역 정책
lockGrantStrategy: 'FIFO' | 'BATCH'

// 데드락 유발 존 전용 정책 (독립)
deadlockZoneStrategy: 'BRANCH_FIFO' | 'ZONE_YIELD'
```

### 적용 흐름

```typescript
if (데드락 유발 존) {
  → deadlockZoneStrategy 적용 (BRANCH_FIFO or ZONE_YIELD)
} else {
  → lockGrantStrategy 적용 (FIFO or BATCH)
}
```

---

## 해결책 1: BRANCH_FIFO

### 개념
데드락 유발 합류점에 대해 **분기 노드 근처 도착 순서대로만 FIFO 락 부여**

### 동작 방식

```
1. 경로 탐색 시 합류점이 "데드락 유발 노드"인지 체크
   (예: N0249, N0346)

2. 해당 합류점은:
   - lockRequestDistance 무시
   - 분기 노드(N0248, N0345) 직전에 도착해야만 락 요청 가능
   - FIFO로 진입 순서대로 승인

3. 결과:
   - 분기 노드 근처에서 속도 저하 (거의 정지 후 진입)
   - 대신 데드락 100% 방지
```

### 장단점

| 장점 | 단점 |
|------|------|
| 구조적으로 확실한 해결 | 해당 구간 처리량 감소 |
| 구현 비교적 단순 | 분기 노드 근처 정체 발생 |
| 기존 BATCH 로직과 분리 가능 | - |

---

## 해결책 2: ZONE_YIELD

### 개념
데드락 유발 노드들을 **하나의 존으로 묶고**, 데드락 조건 감지 시 **락 양보**

### 동작 방식

```
1. 데드락 유발 노드들(N0249, N0346)을 "데드락 존"으로 묶음

2. 락 요청은 기존 방식 유지:
   - 직선: 멀리서 미리 요청
   - 곡선: 근처에서 요청

3. 데드락 조건 감지:
   - A가 N0346 락 요청 + 반대편 B가 N0346 보유
   - B가 N0249 락 필요 (또는 대기 중)
   → 순환 의존성 발생

4. 감지 시 → 반대편(B)이 락 양보
   - B는 N0346 락 해제
   - A가 N0346 획득 후 통과
   - B는 대기 지점에서 감속 후 다시 락 요청
```

### 시나리오 예시

```
Before:
  차량 A: E0549(U턴) → N0346 락 요청 (대기)
  차량 B: E0397(직진) → N0346 락 보유, but N0249 락 필요
  → 데드락 조건 감지

After:
  B가 N0346 락 양보 → A에게 승인
  A 통과 → N0346 해제
  B가 다시 N0346 락 요청 → 승인 → 진행
```

### 장단점

| 장점 | 단점 |
|------|------|
| 기존 락 요청 타이밍 유지 | "양보" 로직 구현 복잡도 |
| 처리량 거의 유지 | 양보 대상 결정 로직 필요 |
| 데드락 상황에서만 개입 | 양보 후 상태 관리 필요 |

---

## 두 해결책 비교

| 항목 | BRANCH_FIFO | ZONE_YIELD |
|------|-------------|------------|
| 데드락 방지 | 원천 차단 | 감지 후 해결 |
| 처리량 | 저하 (분기점 정체) | 유지 (양보 시에만 저하) |
| 구현 복잡도 | 낮음 | 중간~높음 |
| 기존 코드 수정 | 락 요청 타이밍 변경 | 양보 로직 추가 |

---

## 구현 순서

1. **Config 추가** - `deadlockZoneStrategy` 옵션
2. **데드락 존 식별 로직** - 어떤 노드가 데드락 유발 존인지 판별
3. **BRANCH_FIFO 구현** (해결책 1)
4. **ZONE_YIELD 구현** (해결책 2)